{
  "version": 3,
  "sources": ["../src/index.ts", "../src/project.ts"],
  "sourcesContent": ["#!/usr/bin/env node\nimport chokidar from \"chokidar\";\nimport chalk from \"chalk\";\nimport express from \"express\";\nimport * as core from \"express-serve-static-core\";\nimport next from \"next\";\nimport path from \"path\";\nimport { parse } from \"url\";\nimport { collect, Project } from \"./project\";\n\nconst createNextApp = async (root: string, basePath?: string) => {\n  const app = next({\n    dev: true,\n    dir: root,\n    hostname: \"localhost\",\n    port: Number(process.env.PORT) || 3000,\n    conf: {\n      basePath,\n      env: {\n        root,\n      },\n    },\n  });\n\n  return app.prepare().then(async () => {\n    // if directories are provided, watch them for changes and trigger reload\n    const appServer: any =\n      (app as any).server || (await (app as any).getServer());\n    chokidar\n      .watch([\"./book\", \"./glossary\", \"./hyperbook.json\", \"./public\"], {\n        usePolling: false,\n        cwd: root,\n      })\n      .on(\"add\", async (filePath) => {\n        appServer.hotReloader.send(\"building\");\n\n        const global =\n          filePath.startsWith(\"hyperbook.json\") ||\n          filePath.startsWith(\"public\");\n\n        const pages = [];\n        if (filePath.startsWith(\"book\") || global) {\n          pages.push(\"/[[...page]]\");\n        } else if (filePath.startsWith(\"glossary\") || global) {\n          pages.push(\"/glossary/[...term]\", \"/glossary\");\n        }\n\n        // @ts-ignore\n        // https://github.com/hashicorp/next-remote-watch/issues/42\n        appServer.hotReloader.send({\n          event: \"serverOnlyChanges\",\n          pages,\n        });\n      })\n      .on(\"unlink\", async (filePath) => {\n        appServer.hotReloader.send(\"building\");\n\n        const global =\n          filePath.startsWith(\"hyperbook.json\") ||\n          filePath.startsWith(\"public\");\n\n        const pages = [];\n        if (filePath.startsWith(\"book\") || global) {\n          pages.push(\"/[[...page]]\");\n        } else if (filePath.startsWith(\"glossary\") || global) {\n          pages.push(\"/glossary/[...term]\", \"/glossary\");\n        }\n\n        // @ts-ignore\n        // https://github.com/hashicorp/next-remote-watch/issues/42\n        appServer.hotReloader.send({\n          event: \"serverOnlyChanges\",\n          pages,\n        });\n      })\n      .on(\"change\", async (filePath) => {\n        appServer.hotReloader.send(\"building\");\n\n        const global =\n          filePath.startsWith(\"hyperbook.json\") ||\n          filePath.startsWith(\"public\");\n\n        const pages = [];\n        if (filePath.startsWith(\"book\") || global) {\n          pages.push(\"/[[...page]]\");\n        } else if (filePath.startsWith(\"glossary\") || global) {\n          pages.push(\"/glossary/[...term]\", \"/glossary\");\n        }\n\n        // @ts-ignore\n        // https://github.com/hashicorp/next-remote-watch/issues/42\n        appServer.hotReloader.send({\n          event: \"serverOnlyChanges\",\n          pages,\n        });\n      });\n    return app;\n  });\n};\n\nconst handleProject = (server: core.Express) => async (project: Project) => {\n  if (project.type === \"book\") {\n    const root = path.join(project.src, \".hyperbook\");\n    let basePath = project.basePath;\n\n    if (basePath && !basePath.startsWith(\"/\")) {\n      basePath = \"/\" + basePath;\n    }\n\n    if (basePath && basePath.endsWith(\"/\")) {\n      basePath = basePath.slice(0, -1);\n    }\n\n    const app = await createNextApp(root, basePath);\n    const handle = app.getRequestHandler();\n    // handle all other routes with next.js\n    const paths = [project.href, path.join(project.href, \"*\")];\n    server.all(paths, (req, res) => {\n      handle(req as any, res, parse(req.url, true));\n    });\n  } else if (project.type === \"library\") {\n    await Promise.all(project.projects.map(handleProject(server)));\n  }\n};\n\nasync function run() {\n  console.log(`> Starting dev server ...`);\n  const root = path.join(process.cwd(), \"..\");\n  const project = await collect(root);\n  //if (project.type !== \"library\") {\n  //  console.log(\n  //    chalk.red(\n  //      `\\`hyperbook dev\\` is currently not supported for libraries. You have to run \\`hyperbook dev\\` in a folder containing a book.`\n  //    )\n  //  );\n  //  return;\n  //}\n  // create an express server\n  const server = express();\n  await handleProject(server)(project);\n\n  process.chdir(root);\n\n  // fire it up\n  const port = process.env.PORT || 3000;\n  server.listen(port, () => {\n    console.log(`> Ready on http://localhost:${port}`);\n  });\n}\n\nrun();\n", "import {\n  HyperbookJson,\n  HyperlibraryJson,\n  Language,\n  LanguageString,\n  Link,\n} from \"@hyperbook/types\";\nimport fs from \"fs/promises\";\nimport chalk from \"chalk\";\nimport path from \"path\";\n\nexport type Book = {\n  type: \"book\";\n  src: string;\n  basePath?: string;\n  href: string;\n  icon?: string;\n  name: string | LanguageString;\n  template?: string;\n};\n\nexport type Library = {\n  type: \"library\";\n  name: string | LanguageString;\n  basePath?: string;\n  icon?: string;\n  src: string;\n  projects: Project[];\n};\n\nexport type Project = Book | Library;\n\nexport function getProjectName(project: Project, language?: Language) {\n  let label = \"\";\n  if (typeof project.name === \"string\") {\n    label = project.name;\n  } else {\n    if (language) {\n      label = project.name[language] || \"en\";\n    } else {\n      label = Object.values(project.name)[0];\n    }\n    if (!label) {\n      console.log(\n        chalk.red(\n          `You need to provide a name for language ${language} in ${project.src}`\n        )\n      );\n      throw Error(\"\");\n    }\n  }\n  return label;\n}\n\nexport function makeLink(project: Project): Link {\n  if (project.type === \"library\") {\n    return {\n      label: getProjectName(project),\n      links: project.projects.map(makeLink),\n      icon: project.icon,\n    };\n  } else {\n    return {\n      label: getProjectName(project),\n      href: project.href,\n      icon: project.icon,\n    };\n  }\n}\n\nexport async function collect(\n  root: string,\n  basePath?: string,\n  label?: string | LanguageString,\n  icon?: string\n): Promise<Project> {\n  const hyperbookJson = await fs\n    .readFile(path.join(root, \"hyperbook.json\"))\n    .then((data) => JSON.parse(data.toString()) as HyperbookJson)\n    .catch((e) => {\n      if (e instanceof SyntaxError) {\n        console.error(e);\n      }\n      return null;\n    });\n\n  if (hyperbookJson) {\n    let href = basePath ?? hyperbookJson.basePath ?? \"/\";\n    if (!href.startsWith(\"/\")) {\n      href = \"/\" + href;\n    }\n\n    if (href.length > 1 && href.endsWith(\"/\")) {\n      href = href.slice(0, -1);\n    }\n    return {\n      type: \"book\",\n      src: root,\n      href,\n      basePath: basePath ?? hyperbookJson.basePath,\n      template: hyperbookJson.template,\n      name: label ?? hyperbookJson.name,\n      icon,\n    };\n  }\n\n  const hyperlibraryJson = await fs\n    .readFile(path.join(root, \"hyperlibrary.json\"))\n    .then((data) => JSON.parse(data.toString()) as HyperlibraryJson)\n    .catch((e) => {\n      if (e instanceof SyntaxError) {\n        console.error(e);\n      }\n      return null;\n    });\n\n  if (hyperlibraryJson) {\n    const projects = await Promise.all(\n      hyperlibraryJson.library.map(\n        async ({ src, basePath: localBasePath, name, icon }) => {\n          if (!localBasePath) {\n            console.log(\n              chalk.red(\n                `Missing basePath for book ${name} in library ${path.join(\n                  root,\n                  \"hyperlibrary.json\"\n                )}`\n              )\n            );\n          }\n          return collect(\n            path.join(root, src),\n            path.join(\n              basePath ?? hyperlibraryJson.basePath ?? \"\",\n              localBasePath\n            ),\n            name,\n            icon\n          );\n        }\n      )\n    );\n\n    return {\n      type: \"library\",\n      name: label ?? hyperlibraryJson.name,\n      basePath: basePath ?? hyperlibraryJson.basePath,\n      src: root,\n      icon,\n      projects,\n    };\n  }\n\n  console.log(\n    `${chalk.red(\"Error\")} - Missing book or library for path ${root}.`\n  );\n\n  throw Error(`Missing book or library for path ${root}`);\n}\n"],
  "mappings": "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",
  "names": ["path", "icon", "path"]
}
